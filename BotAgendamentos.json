{
  "name": "BotAgendamentos",
  "nodes": [
    {
      "parameters": {
        "model": "openai/gpt-4o",
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.lmChatOpenRouter",
      "typeVersion": 1,
      "position": [
        672,
        272
      ],
      "id": "ec108192-1b3c-4eaf-9459-a7ce9a5956f3",
      "name": "OpenRouter Chat Model",
      "credentials": {
        "openRouterApi": {
          "id": "kspxQlR2uiPnHlvK",
          "name": "OpenRouter account 3"
        }
      }
    },
    {
      "parameters": {
        "databaseId": 263758,
        "tableId": 620288,
        "returnAll": true,
        "additionalOptions": {}
      },
      "type": "n8n-nodes-base.baserowTool",
      "typeVersion": 1,
      "position": [
        1072,
        352
      ],
      "id": "4fd97877-7623-4d8a-bff4-6a111069f803",
      "name": "ClientesCadastrados",
      "credentials": {
        "baserowApi": {
          "id": "TV0un8zAmZbBEp2H",
          "name": "Baserow account"
        }
      }
    },
    {
      "parameters": {
        "operation": "create",
        "databaseId": 263758,
        "tableId": 620288,
        "fieldsUi": {
          "fieldValues": [
            {
              "fieldId": 5044570,
              "fieldValue": "={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('fieldValues0_Field_Value', ``, 'string') }}"
            },
            {
              "fieldId": 5044834,
              "fieldValue": "={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('fieldValues1_Field_Value', ``, 'string') }}"
            },
            {
              "fieldId": 5069540,
              "fieldValue": "={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('fieldValues2_Field_Value', ``, 'string') }}"
            }
          ]
        }
      },
      "type": "n8n-nodes-base.baserowTool",
      "typeVersion": 1,
      "position": [
        1232,
        368
      ],
      "id": "fb0c073b-df6e-4c65-8c13-c7bde2b3cf22",
      "name": "Cadastrar",
      "credentials": {
        "baserowApi": {
          "id": "TV0un8zAmZbBEp2H",
          "name": "Baserow account"
        }
      }
    },
    {
      "parameters": {
        "options": {}
      },
      "type": "n8n-nodes-base.dateTime",
      "typeVersion": 2,
      "position": [
        608,
        0
      ],
      "id": "a52da2fd-224e-44e9-bd7c-f60f6027a987",
      "name": "Date & Time"
    },
    {
      "parameters": {
        "jsCode": "\nreturn { date: $input.first().json.currentDate, \n        sessionId: $('Webhook').first().json.body.message.chat.id };\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        896,
        0
      ],
      "id": "00bc9586-c063-4416-8643-e695f1c32ac1",
      "name": "Code"
    },
    {
      "parameters": {
        "calendar": {
          "__rl": true,
          "value": "b5b8ee9730024dc1b29380f611ded21231f584ecf294b453008d06ed38219fed@group.calendar.google.com",
          "mode": "list",
          "cachedResultName": "Agendamentos"
        },
        "start": "={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('Start', `Data e hor√°rio escolhido pelo usu√°rio. Lembrando, voc√™ NUNCA deve marcar nos s√°bados e domingos, ou antes e depois dos hor√°rios do expediente!`, 'string') }}",
        "end": "={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('End', ``, 'string') }}",
        "additionalFields": {
          "attendees": [
            "={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('attendees0_Attendees', `O guest deve ser o email dado pelo usu√°rio`, 'string') }}"
          ]
        }
      },
      "type": "n8n-nodes-base.googleCalendarTool",
      "typeVersion": 1.3,
      "position": [
        1728,
        288
      ],
      "id": "3d790548-d324-43af-9cc6-a658784435b3",
      "name": "Agendar",
      "credentials": {
        "googleCalendarOAuth2Api": {
          "id": "MYIURlWACHUbPBSw",
          "name": "Lav√≠nia"
        }
      }
    },
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "bot-agendamentos-teste",
        "options": {}
      },
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 2,
      "position": [
        320,
        0
      ],
      "id": "6d27c1f1-96d8-4f73-86ef-cd1268ea4100",
      "name": "Webhook",
      "webhookId": "a6c587fc-42a6-4637-913b-2e6a30900721"
    },
    {
      "parameters": {
        "chatId": "={{ $('Code').item.json.sessionId }}",
        "text": "={{ $json.output }}",
        "additionalFields": {
          "appendAttribution": false
        }
      },
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        1616,
        0
      ],
      "id": "b40fbef2-d004-406a-bd0b-52bf051ba44e",
      "name": "Send a text message",
      "webhookId": "577563c4-a8d7-48f8-a646-4ddc9465e00f",
      "credentials": {
        "telegramApi": {
          "id": "3CjvXriWjvga8ZHc",
          "name": "Telegram account 5"
        }
      }
    },
    {
      "parameters": {
        "promptType": "define",
        "text": "={{ $('Webhook').item.json.body.message.text }}",
        "options": {
          "systemMessage": "=Voc√™ √© um atendente virtual do telegram de uma cl√≠nica. Seu papel √© realizar agendamentos, reagendamentos, cancelamentos e consultas de hor√°rios dispon√≠veis de forma profissional, acolhedora, natural e eficiente.\n\nüü¢ Seu papel √© auxiliar o cliente com:\n- Agendamentos de consulta\n- Reagendamentos\n- Cancelamento \n- Consulta dos hor√°rios marcados pelo cliente\n\n‚ö† Regras Gerais\n- N√£o use dados fict√≠cios em hip√≥tese alguma.\n\n- Nunca mencione que est√° ‚Äúverificando no sistema‚Äù.\n\n- Evite repeti√ß√µes ou mensagens rob√≥ticas.\n\n- Sempre chame o cliente pelo nome.\n\n- Mantenha a conversa fluida, humana e direta ao ponto.\n\nüïó Hor√°rios Dispon√≠veis da Cl√≠nica\nAssim que receber uma mensagem do usu√°rio, seu primeiro papel √© verificar a data e hora atuais em {{ $json.date }}. Voc√™ deve internamente armazenar essas informa√ß√µes, como \"Hoje √© dia XX de XXXX, √†s XXh\"\nO hor√°rio comercial padr√£o de atendimento da cl√≠nica √© de:\n- Manh√£: 07:00 √†s 12:00\n- Tarde: 14:00 √†s 18:00\nCada consulta tem a dura√ß√£o de 1 hora.\nOs hor√°rios de s√°bado e domingo estar√£o completamente indispon√≠veis para agendamento ou reagendamento de consultas.\nLembre-se: Um √∫nico agendamento em um dia n√£o significa que todos est√£o lotados. Se existe um √∫nico atendimento pela manh√£/tarde, isso n√£o coloca os outros hor√°rios como imediatamente indispon√≠veis, com exce√ß√£o se realmente tiver um evento j√° marcado.\n\n---\n\nüìç Etapas do Atendimento\n\n1. Cumprimente e solicite os dados iniciais\nAo primeiro contato do cliente voc√™ deve responder, de forma cordial\n\n\"Ol√°! Tudo bem? üòä\nPara come√ßarmos o atendimento, voc√™ j√° possui um cadastro no nosso sistema?\"\n\n\nPara qualquer uma  das op√ß√µes escolhidas, voc√™ primeiro deve perguntar ao usu√°rio se ele j√° possui um cadastro no sistema. \nSe ele confirmar, pe√ßa o e-mail cadastrado. Use a ferramenta 'ClientesCadastrados' para verificar o cadastro.\n\n**Se estiver cadastrado:**\n\n\"Obrigado, [Nome]!\nEm que posso te ajudar hoje? Voc√™ gostaria de marcar uma consulta, reagendar, cancelar ou apenas verificar seus agendamentos?\"\nE continue com o atendimento de acordo com as instru√ß√µes.\n\n**Se n√£o possuir um cadastro:**\n\nPergunte ao usu√°rio o seu nome completo, e-mail e n√∫mero. Possuindo estas informa√ß√µes, use a ferramenta 'Cadastrar' com os dados fornecidos para registrar o usu√°rio. Os dados nunca devem ser inventados.\nS√≥ ent√£o diga:\n**\"Obrigado, [Nome]! Fiz seu cadastro por aqui.\nEm que posso te ajudar hoje? Voc√™ gostaria de marcar uma consulta, reagendar, cancelar ou apenas verificar seus agendamentos?\"**\nE continue com o atendimento de acordo com as instru√ß√µes.\n\n---\n\n2. Entender a inten√ß√£o do cliente\n\nSe o cliente quiser agendar ou reagendar, pergunte:\n\n\"Voc√™ tem alguma data e hor√°rio em mente, ou gostaria que eu verificasse os pr√≥ximos hor√°rios dispon√≠veis pra voc√™?\"\n\n---\n\n3. Agendamento\n\n\"Voc√™ tem alguma data e hor√°rio em mente, ou gostaria que eu verificasse os pr√≥ximos hor√°rios dispon√≠veis pra voc√™?\"\n\n**Se ele indicar uma data e hor√°rio:**\n\nRevise novamente o {{ $json.date }} para se contextualizar do dia e hora atual.\nSomente ap√≥s essa verifica√ß√£o, voc√™ deve usar a ferramenta 'verificarCalendario', e identificar os hor√°rios dispon√≠veis, baseados naqueles que n√£o tem um evento marcado.\nA depender do hor√°rio, o dia n√£o deve mais ser ofertado.\n\nSe estiver livre:\n\"√ìtimo! Esse hor√°rio est√° dispon√≠vel. Posso confirmar a marca√ß√£o pra voc√™?\"\n\nAo receber a confirma√ß√£o, s√≥ ent√£o voc√™ tem a permiss√£o de fazer a marca√ß√£o do evento no calend√°rio, no dia e hor√°rio escolhidos pelo cliente, com a dura√ß√£o de 1 hora.\n\nSe n√£o estiver dispon√≠vel:\nVoc√™ deve preferencialmente procurar por outros hor√°rios dispon√≠veis nesse mesmo dia solicitado. Se encontrar, diga ao usu√°rio:\n\"Esse hor√°rio infelizmente j√° est√° ocupado. Veja as op√ß√µes que tenho no mesmo dia:\n[listar hor√°rios dispon√≠veis divididos por turnos].\nGostaria de escolher um deles ou quer que eu verifique os pr√≥ximos dias?\"\n\nCaso o DIA esteja completamente preenchido, verifique os pr√≥ximos dois dias v√°lidos, e com hor√°rios dispon√≠veis. S√≥ ent√£o diga ao usu√°rio:\n\"Infelizmente n√£o h√° mais vagas dispon√≠veis para este dia. Mas temos as seguintes op√ß√µes para os pr√≥ximos dias: \"\n\n-A depender do hor√°rio atual, nem todos os hor√°rios vagos devem ser ofertados ao usu√°rio. Se voc√™ verificar, pela hora, que, por exemplo, j√° estamos nesta quinta feira, no per√≠odo da tarde, (como 16h), voc√™ √© PROIBIDO de oferecer hor√°rios ANTERIORES a este ao usu√°rio, mesmo que ele insista.\n\n**Se ele n√£o indicar uma data e hor√°rio:**\n\nVerifique os pr√≥ximos dois dias v√°lidos, e com hor√°rios dispon√≠veis. S√≥ ent√£o diga ao usu√°rio:\n\"Infelizmente n√£o h√° mais vagas dispon√≠veis para este dia. Mas temos as seguintes op√ß√µes para os pr√≥ximos dias: \"\n\n-A depender do hor√°rio atual, nem todos os hor√°rios vagos devem ser ofertados ao usu√°rio. Se voc√™ verificar, pela hora, que, por exemplo, j√° estamos nesta quinta feira, no per√≠odo da tarde, (como 16h), voc√™ √© PROIBIDO de oferecer hor√°rios ANTERIORES a este ao usu√°rio, mesmo que ele insista.\n\nLembre-se: Um √∫nico agendamento em um dia n√£o significa que todos est√£o lotados.\n\nExemplo:\nSe algu√©m marcou uma vaga na sexta 13h, isso N√ÉO IMPEDE outro usu√°rio de marcar sexta 14h, 15h, 16h ou 17h, se esses hor√°rios ainda estiverem vagos, sem nenhum evento.\n\n4. Reagendamento \nSe o cliente deseja reagendar uma consulta, voc√™ deve perguntar a ele somente o e-mail. Por meio disso, ser√° verificado em 'ClientesCadastrados' se ele √© algu√©m cadastrado.\n\nSe for:\nVerifique na agenda se h√° um evento marcado por aquele e-mail, e confirme com o usu√°rio se os dados est√£o corretos, antes de fazer a exclus√£o.\nCaso haja mais de um evento cadastrado no mesmo e-mail, mostre os dois ao usu√°rio e pergunte qual deles ele deseja reagenda. S√≥ exclua ap√≥s confirmar mais uma vez que o usu√°rio selecionou o evento correto.\n\nAp√≥s a confirma√ß√£o, voc√™ deve Verificar o hor√°rio a ser cancelado mais uma vez, confirmando seu ID. Com o ID em m√£os, voc√™ pode prosseguir com o cancelamento do hor√°rio antigo.\n\nLogo depois, pergunte qual a nova data o usu√°rio vai querer para o agendamento, e continue de acordo com as regras de agendamento normal.\n\nVoc√™ deve marcar o agendamento para o dia e hor√°rio escolhidos pelo usu√°rio, especificando seu t√≠tulo como \"Consulta de [Nome Completo do Sistema de Cadastro]\".\n\n5. Cancelamento\n\nSe o cliente deseja cancelar uma consulta, voc√™ deve perguntar a ele seu e-mail de cadastro. Por meio disso, ser√° verificado em 'ClientesCadastrados' se ele √© algu√©m cadastrado.\n\nSe for:\nVerifique na agenda se h√° um evento marcado por aquele e-mail, e confirme com o usu√°rio se os dados est√£o corretos, antes de fazer a exclus√£o.\n\nCaso haja mais de um evento cadastrado no mesmo e-mail, mostre os dois ao usu√°rio e pergunte qual deles ele deseja cancelar. S√≥ exclua ap√≥s confirmar mais uma vez que o usu√°rio selecionou o evento correto. \n\nAp√≥s a confirma√ß√£o, voc√™ deve Verificar o hor√°rio a ser cancelado mais uma vez, confirmando seu ID. Com o ID em m√£os, voc√™ pode prosseguir com o cancelamento do hor√°rio antigo.\n\nSe o usu√°rio tiver verificado os pr√≥prios hor√°rios de agendamento, j√° l√≥gico, e dizer que deseja cancelar um deles, voc√™ s√≥ precisa fazer a confirma√ß√£o com o usu√°rio antes de apagar. √â obrigat√≥rio que voc√™ apague dos agendamentos usando a ferramenta \"Cancelar\"\n"
        }
      },
      "type": "@n8n/n8n-nodes-langchain.agent",
      "typeVersion": 2.1,
      "position": [
        1152,
        0
      ],
      "id": "35aabcb3-d6b4-484f-ba00-b6ba41ccdeca",
      "name": "AI Agent"
    },
    {
      "parameters": {},
      "type": "@n8n/n8n-nodes-langchain.memoryBufferWindow",
      "typeVersion": 1.3,
      "position": [
        848,
        336
      ],
      "id": "065e872c-2546-4851-b820-67e14f6fbef4",
      "name": "Simple Memory"
    },
    {
      "parameters": {
        "operation": "getAll",
        "calendar": {
          "__rl": true,
          "value": "b5b8ee9730024dc1b29380f611ded21231f584ecf294b453008d06ed38219fed@group.calendar.google.com",
          "mode": "list",
          "cachedResultName": "Agendamentos"
        },
        "returnAll": true,
        "options": {
          "recurringEventHandling": "expand"
        }
      },
      "type": "n8n-nodes-base.googleCalendarTool",
      "typeVersion": 1.3,
      "position": [
        1456,
        352
      ],
      "id": "5a6d1e87-e9a8-423c-ba85-79e8ee93fc27",
      "name": "VerificarHorarios",
      "credentials": {
        "googleCalendarOAuth2Api": {
          "id": "MYIURlWACHUbPBSw",
          "name": "Lav√≠nia"
        }
      }
    },
    {
      "parameters": {
        "operation": "delete",
        "calendar": {
          "__rl": true,
          "value": "b5b8ee9730024dc1b29380f611ded21231f584ecf294b453008d06ed38219fed@group.calendar.google.com",
          "mode": "list",
          "cachedResultName": "Agendamentos"
        },
        "eventId": "={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('Event_ID', `Use a ferramenta \"VerificarHorario\" para identificar o ID do evento a ser cancelado. Com o ID em m√£os, voc√™ pode prosseguir com o cancelamento do hor√°rio antigo.\n`, 'string') }}",
        "options": {}
      },
      "type": "n8n-nodes-base.googleCalendarTool",
      "typeVersion": 1.3,
      "position": [
        1584,
        384
      ],
      "id": "12277a01-5152-4552-98b8-2e7845102d82",
      "name": "CancelarHorario",
      "credentials": {
        "googleCalendarOAuth2Api": {
          "id": "MYIURlWACHUbPBSw",
          "name": "Lav√≠nia"
        }
      }
    }
  ],
  "pinData": {},
  "connections": {
    "OpenRouter Chat Model": {
      "ai_languageModel": [
        [
          {
            "node": "AI Agent",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    },
    "ClientesCadastrados": {
      "ai_tool": [
        [
          {
            "node": "AI Agent",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "Cadastrar": {
      "ai_tool": [
        [
          {
            "node": "AI Agent",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "Date & Time": {
      "main": [
        [
          {
            "node": "Code",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Code": {
      "main": [
        [
          {
            "node": "AI Agent",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Agendar": {
      "ai_tool": [
        [
          {
            "node": "AI Agent",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "Webhook": {
      "main": [
        [
          {
            "node": "Date & Time",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "AI Agent": {
      "main": [
        [
          {
            "node": "Send a text message",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Simple Memory": {
      "ai_memory": [
        [
          {
            "node": "AI Agent",
            "type": "ai_memory",
            "index": 0
          }
        ]
      ]
    },
    "VerificarHorarios": {
      "ai_tool": [
        [
          {
            "node": "AI Agent",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "CancelarHorario": {
      "ai_tool": [
        [
          {
            "node": "AI Agent",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    }
  },
  "active": true,
  "settings": {
    "executionOrder": "v1"
  },
  "versionId": "3a76ce01-e3c0-437f-aafd-b1fd5253ee06",
  "meta": {
    "templateCredsSetupCompleted": true,
    "instanceId": "9aab45911b97299333480ee93b3a756a301732a8d3c5c2882e1becb4b9fe223a"
  },
  "id": "f3ASYPKt9asK7Zfe",
  "tags": []
}